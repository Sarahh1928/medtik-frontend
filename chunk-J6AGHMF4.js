import{a as de}from"./chunk-TQOOYVQA.js";import"./chunk-CBB6Q34Z.js";import{a as le}from"./chunk-KADNFXRE.js";import{a as ce}from"./chunk-KP7QXJR3.js";import"./chunk-GFO3VGSQ.js";import"./chunk-XDTU2MFJ.js";import{a as oe,b as se}from"./chunk-CQ63BDYT.js";import{T as ie,Y as re,Z as ae}from"./chunk-YNMGB45N.js";import{a as P,b as ne}from"./chunk-F426BNRH.js";import{b as ee,h as te}from"./chunk-RXNQWMFM.js";import{$b as F,Bb as T,Db as b,Fb as m,Gc as H,Hc as R,Ia as M,Ic as X,Jb as z,Jc as K,Kb as L,Kc as W,Lb as j,Ma as d,Pb as q,Pc as G,Qa as A,Rb as E,Sc as J,Tb as l,Ub as u,Xa as V,Yc as Y,Zc as Z,a as C,ab as x,b as I,e as B,ea as y,ec as D,gc as U,hc as Q,ja as f,ka as v,l as $,lc as O,rb as p,sb as s,ta as _,tb as c,ub as w,yb as S,zb as k}from"./chunk-BE7DJT6W.js";var me=["scrollArea"];function ge(o,e){if(o&1&&(s(0,"span",29),l(1),c()),o&2){let t=m().$implicit;d(),u(t.unread)}}function ue(o,e){if(o&1){let t=T();s(0,"button",26),b("click",function(){let i=f(t).$implicit,a=m();return v(a.select(i))}),w(1,"img",15),s(2,"div",27)(3,"div",16),l(4),c(),s(5,"div",17),l(6),c()(),x(7,ge,2,1,"span",28),c()}if(o&2){let t,n=e.$implicit,i=m();E("active",((t=i.activeThread())==null?null:t.userId)===n.userId),d(),p("alt",F(n.name))("src",n.avatarUrl,M),d(3),u(n.name),d(2),u(n.spec),d(),p("ngIf",n.unread)}}function he(o,e){o&1&&w(0,"span",30)}function fe(o,e){if(o&1&&(s(0,"div",38),l(1),D(2,"date"),c()),o&2){let t=m().$implicit;d(),u(U(2,1,t.ts,"hh:mm a"))}}function ve(o,e){if(o&1&&(s(0,"div",39),l(1),c()),o&2){let t=m().$implicit;d(),u(t.text)}}function xe(o,e){if(o&1&&(S(0),w(1,"img",42),k()),o&2){let t=m(2).$implicit,n=m();d(),p("src",n.getFileUrl(t.text),M)}}function _e(o,e){if(o&1&&(s(0,"a",43),l(1),c()),o&2){let t=m(2).$implicit,n=m();p("href",n.getFileUrl(t.text),M),d(),u(n.getFileName(t.text))}}function be(o,e){if(o&1&&(s(0,"div",40),x(1,xe,2,1,"ng-container",41)(2,_e,2,2,"ng-template",null,1,Q),c()),o&2){let t=q(3),n=m().$implicit,i=m();d(),p("ngIf",i.isImage(n.text))("ngIfElse",t)}}function Ce(o,e){if(o&1&&(s(0,"div",39),l(1),c()),o&2){let t=m().$implicit;d(),u(t.text)}}function Ie(o,e){o&1&&(s(0,"span"),l(1," \u2022 seen"),c())}function ye(o,e){if(o&1&&(S(0),s(1,"div",31),x(2,fe,3,4,"div",32),S(3,33),x(4,ve,2,1,"div",34)(5,be,4,2,"div",35)(6,Ce,2,1,"div",36),k(),s(7,"div",27)(8,"span"),l(9),D(10,"date"),c(),x(11,Ie,2,0,"span",37),c()(),k()),o&2){let t=e.$implicit;d(),E("me",t.from==="me"),d(),p("ngIf",t.showStamp),d(),p("ngSwitch",t.type),d(),p("ngSwitchCase","TEXT"),d(),p("ngSwitchCase","FILE"),d(4),u(U(10,8,t.ts,"shortTime")),d(2),p("ngIf",t.from==="me"&&t.seen)}}var N=()=>Math.random().toString(36).slice(2,10),pe=class o{constructor(e){this.snack=e;this.loadDoctors()}route=y(ee);patientService=y(le);scrollArea;query=_("");chatQuery=_("");draft=_("");threads=_([]);selectedUserId=_("");http=y(Z);store={};version=_(0);socketService=y(ce);_patientId$=new $(0);onlineUsers=_(new Set);auth=y(ne);BACKEND_URL=P.socketUrl;requestOptions(){if(P.production)return{withCredentials:!0};{let e=this.auth.getToken();if(!e)throw new Error("Doctor session expired.");return{headers:new Y({Authorization:`Bearer ${e}`})}}}fetchPatientId(){this.http.get(`${P.apiBaseUrl}/auth/me`,this.requestOptions()).subscribe({next:e=>{console.log("\u{1F464} Fetched patientId:",e.id),this._patientId$.next(e.id)},error:e=>{console.error("\u274C Failed to fetch patientId:",e),this._patientId$.next(0)}})}get patientId(){return this._patientId$.value}ngOnInit(){this.fetchPatientId(),this._patientId$.subscribe(e=>{console.log("ID:"+e),e&&(this.socketService.on("newMessage",t=>{let n="d-"+(t.senderId===e?t.receiverId:t.senderId),i=this.store[n]||[];this.store[n]=[...i,I(C({},t),{from:t.senderId===e?"me":"doc",ts:t.createdAt?new Date(t.createdAt):new Date})],setTimeout(()=>this.scrollToBottom(),100),this.version.set(this.version()+1)}),this.socketService.onlineUsers$.subscribe(t=>{this.threads.update(n=>n.map(i=>I(C({},i),{online:t.has(Number(i.userId))})))}))})}ngOnDestroy(){this.socketService.emit("chatBlurred")}loadChatHistory(e){this.patientService.getChatHistory(e).subscribe({next:t=>{let n=Array.isArray(t)?t:t.messages;if(!n)return;let i=t.messages[0].conversationId,a="d-"+e;this.store[a]=n.map(r=>{let g=r.content?.includes("/uploads/")||r.type==="FILE";return{id:String(r.id),senderId:r.senderId,receiverId:r.senderId==this.patientId?r.receiverId:r.senderId,from:r.senderId==this.patientId?"me":"doc",text:r.content,type:g?"FILE":"TEXT",ts:r.createdAt?new Date(r.createdAt):new Date,seen:r.seen,createdAt:r.createdAt}}),i&&(this.socketService.emit("chatFocused",{conversationId:i}),this.focusChat(i,e),this.markSeen(i,e)),this.version.set(this.version()+1),setTimeout(()=>this.scrollToBottom(),100)},error:t=>console.error("Failed to load chat history",t)})}focusChat(e,t){this.socketService.emit("chatFocused",{conversationId:e});let n="d-"+t,i=this.store[n]||[],a=i.filter(r=>!r.seen);a.length&&(this.socketService.emit("markSeen",{conversationId:e,userId:this.patientId,messageIds:a.map(r=>r.id)}),this.store[n]=i.map(r=>I(C({},r),{seen:!0})),this.version.set(this.version()+1))}markSeen(e,t){let n="d-"+t,i=this.store[n]||[];i.filter(r=>!r.seen).length&&(this.socketService.emit("markSeen",{conversationId:e,userId:this.patientId}),this.store[n]=i.map(r=>I(C({},r),{seen:!0})),this.version.set(this.version()+1))}loadDoctors(){let e=this.route.snapshot.paramMap.get("threadId")||"",t=this.socketService.onlineUsers$.value;this.patientService.getMyDoctors().subscribe(n=>{if(!n||!n.length)return;let i=n.map(r=>({userId:r.userId,id:"d-"+r.userId,name:r.fullName,spec:r.department,avatarUrl:r.avatarUrl,online:t.has(r.userId)}));this.threads.set([...i]);let a=i.find(r=>r.userId==e);a||(a=i[0]),a&&(this.selectedUserId.set(a.userId),this.loadChatHistory(Number(a.userId)))})}activeThread=O(()=>{let e=this.threads();if(e.length)return e.find(t=>t.userId==this.selectedUserId())||e[0]});filteredThreads=O(()=>{let e=this.query().trim().toLowerCase();return e?this.threads().filter(t=>t.name.toLowerCase().includes(e)||t.spec.toLowerCase().includes(e)):this.threads()});messages=O(()=>{this.version();let e=this.activeThread();if(!e)return[];let t=this.store[e.id]||[],n=this.chatQuery().trim().toLowerCase(),i=n?t.filter(a=>a.text.toLowerCase().includes(n)):t;return i.map((a,r)=>{let g=i[r-1],h=g?a.ts.getTime()-g.ts.getTime():1/0;return I(C({},a),{showStamp:h>1e3*60*20})})});trackById=(e,t)=>t.id;select(e){this.selectedUserId.set(e.userId),this.threads.set(this.threads().map(t=>t.userId==e.userId?I(C({},t),{unread:0}):t)),this.loadChatHistory(Number(e.userId))}loadEarlier(){let e=this.activeThread(),t=Number(e?.userId),n=this.patientId;if(!e)return;let i=[{id:N(),from:"doc",text:"Previous notes\u2026",ts:new Date(Date.now()-1e3*60*60*5),senderId:t,receiverId:n,seen:!0}];this.store[e.id]=[...i,...this.store[e.id]||[]],this.version.set(this.version()+1)}attach(){let e=document.createElement("input");e.type="file",e.multiple=!1,e.onchange=()=>B(this,null,function*(){let t=e.files?.[0];if(!t)return;let n=this.activeThread();if(!n)return;let i=Number(n.userId),a=new FormData;a.append("file",t),a.append("receiverId",i.toString());let r={id:N(),senderId:this.patientId,receiverId:i,from:"me",text:`Uploading ${t.name}...`,ts:new Date,seen:!1,type:"FILE"},g=this.store[n.id]||[];this.store[n.id]=[...g,r],this.version.set(this.version()+1),setTimeout(()=>this.scrollToBottom(),100),this.patientService.sendFileToServer(a).subscribe({next:h=>{r.text=h.fileUrl,this.version.set(this.version()+1),this.socketService.emit("sendMessage",{senderId:this.patientId,receiverId:i,content:h.fileUrl,type:"FILE"})},error:h=>{console.error("Failed to upload file",h),r.text=`Failed to upload ${t.name}`,this.version.set(this.version()+1)}})}),e.click()}send(){let e=this.activeThread(),t=this.patientId;if(!e||!t)return;let n=this.draft().trim();if(!n)return;let i=Number(e.userId),a={id:N(),senderId:t,receiverId:i,from:"me",text:n,ts:new Date,seen:!1},r=this.store[e.id]||[];this.store[e.id]=[...r,a],this.draft.set(""),this.version.set(this.version()+1),this.socketService.emit("sendMessage",{senderId:t,receiverId:i,content:n,type:"TEXT"}),this.patientService.sendMessageToServer(n,i).subscribe({next:g=>{setTimeout(()=>this.scrollToBottom(),100)},error:g=>{console.error("Failed to send message",g)}}),this.socketService.once("messageAck",()=>{a.seen=!0,this.version.set(this.version()+1)})}scrollToBottom(){try{this.scrollArea.nativeElement.scrollTop=this.scrollArea.nativeElement.scrollHeight}catch(e){console.error("Scroll failed:",e)}}getFileUrl(e){return e.startsWith("http")?e:`${this.BACKEND_URL}${e}`}isImage(e){return/\.(jpg|jpeg|png|gif|webp)$/i.test(e)}getFileName(e){return e.split("/").pop()||"file"}static \u0275fac=function(t){return new(t||o)(A(de))};static \u0275cmp=V({type:o,selectors:[["app-patient-chat"]],viewQuery:function(t,n){if(t&1&&z(me,5),t&2){let i;L(i=j())&&(n.scrollArea=i.first)}},decls:39,vars:13,consts:[["scrollArea",""],["downloadLink",""],[1,"chat-vert"],[1,"strip-panel","card"],[1,"strip-header"],[1,"title"],[1,"search"],["placeholder","Search doctors",1,"search-input",3,"input","value"],[1,"search-ico"],["tabindex","0","aria-label","Conversations",1,"strip"],["class","tile",3,"active","click",4,"ngFor","ngForOf","ngForTrackBy"],[1,"conversation","card","panel"],[1,"conv-header"],[1,"doc"],["class","presence",4,"ngIf"],[1,"avatar",3,"src","alt"],[1,"name"],[1,"sub"],["placeholder","Search in chat\u2026",1,"inline-search",3,"input","value"],["mat-stroked-button","",1,"load",3,"click"],[1,"conv-body"],[4,"ngFor","ngForOf","ngForTrackBy"],[1,"composer"],["mat-icon-button","",1,"ghost",3,"click"],["placeholder","Type your message\u2026",1,"draft",3,"keydown.enter","input","value"],["mat-flat-button","","color","primary",3,"click"],[1,"tile",3,"click"],[1,"meta"],["class","badge",4,"ngIf"],[1,"badge"],[1,"presence"],[1,"msg"],["class","stamp",4,"ngIf"],[3,"ngSwitch"],["class","bubble",4,"ngSwitchCase"],["class","bubble file-msg",4,"ngSwitchCase"],["class","bubble",4,"ngSwitchDefault"],[4,"ngIf"],[1,"stamp"],[1,"bubble"],[1,"bubble","file-msg"],[4,"ngIf","ngIfElse"],["alt","File",1,"file-preview",3,"src"],["target","_blank",3,"href"]],template:function(t,n){if(t&1){let i=T();s(0,"div",2)(1,"section",3)(2,"div",4)(3,"div",5)(4,"mat-icon"),l(5,"forum"),c(),s(6,"h2"),l(7,"Messages"),c()(),s(8,"div",6)(9,"input",7),b("input",function(r){return f(i),v(n.query.set(r.target.value))}),c(),s(10,"mat-icon",8),l(11,"search"),c()()(),s(12,"div",9),x(13,ue,8,8,"button",10),c()(),s(14,"section",11)(15,"header",12)(16,"div",13),x(17,he,1,0,"span",14),w(18,"img",15),s(19,"div")(20,"div",16),l(21),c(),s(22,"div",17),l(23),c()()(),s(24,"input",18),b("input",function(r){return f(i),v(n.chatQuery.set(r.target.value))}),c()(),s(25,"button",19),b("click",function(){return f(i),v(n.loadEarlier())}),l(26,"Load earlier"),c(),s(27,"div",20,0),x(29,ye,12,11,"ng-container",21),c(),s(30,"footer",22)(31,"button",23),b("click",function(){return f(i),v(n.attach())}),s(32,"mat-icon"),l(33,"attach_file"),c()(),s(34,"input",24),b("keydown.enter",function(){return f(i),v(n.send())})("input",function(r){return f(i),v(n.draft.set(r.target.value))}),c(),s(35,"button",25),b("click",function(){return f(i),v(n.send())}),s(36,"mat-icon"),l(37,"send"),c(),l(38," Send "),c()()()()}if(t&2){let i,a,r,g,h;d(9),p("value",n.query()),d(4),p("ngForOf",n.filteredThreads())("ngForTrackBy",n.trackById),d(4),p("ngIf",(i=n.activeThread())==null?null:i.online),d(),p("alt",F((a=n.activeThread())==null?null:a.name))("src",(r=n.activeThread())==null?null:r.avatarUrl,M),d(3),u((g=n.activeThread())==null?null:g.name),d(2),u((h=n.activeThread())==null?null:h.spec),d(),p("value",n.chatQuery()),d(5),p("ngForOf",n.messages())("ngForTrackBy",n.trackById),d(5),p("value",n.draft())}},dependencies:[J,H,R,X,K,W,te,se,oe,ae,re,ie,G],styles:['@charset "UTF-8";.chat-vert[_ngcontent-%COMP%]{max-width:var(--container);margin:0 auto;padding:12px 12px 28px;display:grid;gap:18px}.strip-panel.card[_ngcontent-%COMP%]{position:sticky;top:8px;z-index:5;padding:14px;border-radius:var(--radius-xl);background:var(--surface);border:1px solid var(--border);box-shadow:var(--shadow-sm)}.strip-header[_ngcontent-%COMP%]{display:grid;grid-template-columns:auto 1fr;gap:14px;align-items:center;margin-bottom:10px}.strip-header[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px}.strip-header[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0}.strip-header[_ngcontent-%COMP%]   .search[_ngcontent-%COMP%]{position:relative}.search-input[_ngcontent-%COMP%]{width:100%;height:42px;padding:0 40px 0 14px;border-radius:14px;border:1px solid var(--border);background:#ffffff0a;color:var(--text)}.search-ico[_ngcontent-%COMP%]{position:absolute;right:10px;top:50%;translate:0 -50%;opacity:.7}.strip[_ngcontent-%COMP%]{display:grid;grid-auto-flow:column;grid-auto-columns:max-content;gap:14px;overflow-x:auto;padding-bottom:4px;scrollbar-width:thin}.tile[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;padding:8px 14px;border-radius:999px;border:1px solid var(--border);background:#ffffff08;color:var(--text);cursor:pointer;white-space:nowrap}.tile.active[_ngcontent-%COMP%]{background:linear-gradient(180deg,#1db7a024,#3b8bd31a);box-shadow:0 8px 20px #3b8bd32e}.tile[_ngcontent-%COMP%]   .avatar[_ngcontent-%COMP%]{width:34px;height:34px;border-radius:50%;object-fit:cover}.tile[_ngcontent-%COMP%]   .meta[_ngcontent-%COMP%]{display:grid;line-height:1.1}.tile[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{font-weight:700;letter-spacing:.2px}.tile[_ngcontent-%COMP%]   .sub[_ngcontent-%COMP%]{font-size:12px;opacity:.8}.tile[_ngcontent-%COMP%]   .time[_ngcontent-%COMP%]{margin-left:6px;font-size:12px;opacity:.75}.tile[_ngcontent-%COMP%]   .badge[_ngcontent-%COMP%]{margin-left:8px;font-size:12px;background:var(--brand-600);color:#fff;padding:2px 8px;border-radius:999px}.conversation.card.panel[_ngcontent-%COMP%]{display:grid;gap:14px;padding:0 0 12px;border-radius:var(--radius-xl);border:1px solid var(--border);background:var(--surface);box-shadow:var(--shadow)}.conv-header[_ngcontent-%COMP%]   .doc[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px}.conv-header[_ngcontent-%COMP%]   .avatar[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:50%;object-fit:cover}.conv-header[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{font-weight:800;margin-bottom:2px}.conv-header[_ngcontent-%COMP%]   .sub[_ngcontent-%COMP%]{font-size:12.5px;opacity:.85}.conv-header[_ngcontent-%COMP%]   .presence[_ngcontent-%COMP%]{width:9px;height:9px;border-radius:50%;background:#22c55e;display:inline-block;box-shadow:0 0 0 3px #22c55e2e}.inline-search[_ngcontent-%COMP%]{width:min(360px,42vw);height:38px;border-radius:12px;border:1px solid var(--border);padding:0 12px;background:#ffffff0d;color:var(--text)}.load[_ngcontent-%COMP%]{align-self:center;width:max-content;margin:10px auto 0}.conv-body[_ngcontent-%COMP%]{display:grid;gap:10px;padding:8px 16px 18px;min-height:62vh}.msg[_ngcontent-%COMP%]{display:grid;justify-content:start;gap:6px}.msg.me[_ngcontent-%COMP%]{justify-content:end}.msg[_ngcontent-%COMP%]   .stamp[_ngcontent-%COMP%]{place-self:center;font-size:12px;opacity:.8;background:#ffffff0f;padding:2px 10px;border-radius:999px}.bubble[_ngcontent-%COMP%]{max-width:70ch;padding:12px 14px;border-radius:16px;border:1px solid var(--border);background:#ffffff0d;line-height:1.35}.msg.me[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{background:linear-gradient(180deg,#3b8bd32e,#1db7a01f);border-color:#3b8bd340}.msg[_ngcontent-%COMP%]   .meta[_ngcontent-%COMP%]{font-size:12px;opacity:.8;margin-top:2px;text-align:right}.composer[_ngcontent-%COMP%]{position:sticky;bottom:8px;z-index:3;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;padding:10px 12px;margin:0 12px 8px;border-radius:16px;border:1px solid var(--border);background:linear-gradient(180deg,#0a0e16e6,#0a0e16db);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px)}.composer[_ngcontent-%COMP%]   .draft[_ngcontent-%COMP%]{height:44px;border-radius:12px;border:1px solid var(--border);background:#ffffff0a;color:var(--text);padding:0 12px}.composer[_ngcontent-%COMP%]   .ghost[_ngcontent-%COMP%]{opacity:.8}[_ngcontent-%COMP%]:root{--chat-offset: 180px}.conversation.card.panel[_ngcontent-%COMP%]{display:grid;grid-template-rows:auto minmax(0,1fr) auto;gap:14px;padding:0 0 12px;border-radius:var(--radius-xl);border:1px solid var(--border);background:var(--surface);box-shadow:var(--shadow);height:calc(100vh - var(--chat-offset));max-height:92vh;overflow:hidden}.conv-header[_ngcontent-%COMP%]{position:sticky;top:0;z-index:4;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0a0e16f2,#0a0e16cc);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);border-top-left-radius:var(--radius-xl);border-top-right-radius:var(--radius-xl)}.conv-body[_ngcontent-%COMP%]{display:grid;gap:10px;padding:8px 16px 18px;overflow-y:auto;overflow-x:hidden;overscroll-behavior:contain;scrollbar-gutter:stable both-edges}.composer[_ngcontent-%COMP%]{position:relative;bottom:auto;z-index:3;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;padding:10px 12px;margin:0 12px 8px;border-radius:16px;border:1px solid var(--border);background:linear-gradient(180deg,#0a0e16e6,#0a0e16db);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px)}.chat-vert[_ngcontent-%COMP%]{height:100dvh;overflow:hidden;display:grid;grid-template-rows:auto 1fr}.strip-panel.card[_ngcontent-%COMP%]{position:sticky;top:8px;z-index:8}.conversation.card.panel[_ngcontent-%COMP%]{height:100%;overflow:hidden;display:grid;grid-template-rows:auto minmax(0,1fr) auto;gap:14px}.conv-header[_ngcontent-%COMP%]{position:sticky;top:0;z-index:4}.conv-body[_ngcontent-%COMP%]{overflow-y:auto;overflow-x:hidden;min-height:0;padding:8px 16px 18px;scrollbar-gutter:stable both-edges;overscroll-behavior:contain}.composer[_ngcontent-%COMP%]{position:relative;bottom:auto;margin:0 12px 8px}']})};export{pe as Chat};
