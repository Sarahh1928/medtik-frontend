import{a as R}from"./chunk-MUHS2OZJ.js";import{a as J}from"./chunk-LVHP3QQG.js";import"./chunk-4EZBTZIU.js";import{a as $,b as H}from"./chunk-W6QHVSTW.js";import{T as q,Y as L,Z as Q}from"./chunk-YSTQL2PO.js";import{b as B,h as j}from"./chunk-QJG5D5WU.js";import{$ as w,Ac as V,Bc as z,Da as k,Ga as d,Jc as A,Lb as P,Mc as U,Nb as p,Ob as h,Ra as E,Vb as T,Wa as _,_b as S,ac as D,ea as m,fa as u,fc as I,lb as l,mb as a,nb as s,oa as v,ob as y,sb as N,tb as F,vb as O,xb as b,zb as C}from"./chunk-HKUWCROW.js";import{a as f,b as x}from"./chunk-JKOY2XUY.js";function K(c,t){if(c&1&&(a(0,"span",28),p(1),s()),c&2){let e=C().$implicit;d(),h(e.unread)}}function W(c,t){if(c&1){let e=O();a(0,"button",25),b("click",function(){let r=m(e).$implicit,i=C();return u(i.select(r))}),y(1,"img",14),a(2,"div",26)(3,"div",15),p(4),s(),a(5,"div",16),p(6),s()(),_(7,K,2,1,"span",27),s()}if(c&2){let e,n=t.$implicit,r=C();P("active",((e=r.activeThread())==null?null:e.userId)===n.userId),d(),l("alt",T(n.name))("src",n.avatarUrl,k),d(3),h(n.name),d(2),h(n.spec),d(),l("ngIf",n.unread)}}function Y(c,t){c&1&&y(0,"span",29)}function Z(c,t){if(c&1&&(a(0,"div",34),p(1),S(2,"date"),s()),c&2){let e=C().$implicit;d(),h(D(2,1,e.ts,"hh:mm a"))}}function ee(c,t){c&1&&(a(0,"span"),p(1," \u2022 seen"),s())}function te(c,t){if(c&1&&(N(0),a(1,"div",30),_(2,Z,3,4,"div",31),a(3,"div",32),p(4),s(),a(5,"div",26)(6,"span"),p(7),S(8,"date"),s(),_(9,ee,2,0,"span",33),s()(),F()),c&2){let e=t.$implicit;d(),P("me",e.from==="me"),d(),l("ngIf",e.showStamp),d(2),h(e.text),d(3),h(D(8,6,e.ts,"shortTime")),d(2),l("ngIf",e.from==="me"&&e.seen)}}var X=()=>Math.random().toString(36).slice(2,10),G=class c{route=w(B);doctorService=w(R);query=v("");chatQuery=v("");draft=v("");threads=v([]);selectedUserId=v("");store={};version=v(0);socket;constructor(){this.loadDoctors()}get patientId(){let t=localStorage.getItem("medtik_token");if(!t)return 0;try{return JSON.parse(atob(t.split(".")[1])).id}catch{return 0}}ngOnInit(){let t=this.patientId;if(!t)return console.error("Patient ID missing!");this.socket=J("http://localhost:4000",{auth:{role:"PATIENT",userId:t}}),this.socket.emit("join",t),this.socket.on("newMessage",e=>{let n="d-"+(e.senderId===t?e.receiverId:e.senderId),r=this.store[n]||[];this.store[n]=[...r,x(f({},e),{from:e.senderId===t?"me":"doc",ts:e.createdAt?new Date(e.createdAt):new Date})],this.version.set(this.version()+1)})}loadChatHistory(t){this.doctorService.getChatHistory(t).subscribe({next:e=>{let n=Array.isArray(e)?e:e.messages;if(!n)return;let r=e.messages[0].conversationId,i="d-"+t;this.store[i]=n.map(o=>({id:String(o.id),senderId:o.senderId,receiverId:o.senderId==this.patientId?o.receiverId:o.senderId,from:o.senderId==this.patientId?"me":"doc",text:o.content,ts:o.createdAt?new Date(o.createdAt):new Date,seen:o.seen,createdAt:o.createdAt})),r&&(this.socket.emit("chatFocused",{conversationId:r}),this.focusChat(r,t),this.markSeen(r,t)),this.version.set(this.version()+1)},error:e=>console.error("Failed to load chat history",e)})}focusChat(t,e){this.socket.emit("chatFocused",{conversationId:t});let n="d-"+e,r=this.store[n]||[],i=r.filter(o=>!o.seen);i.length&&(this.socket.emit("markSeen",{conversationId:t,userId:this.patientId,messageIds:i.map(o=>o.id)}),this.store[n]=r.map(o=>x(f({},o),{seen:!0})),this.version.set(this.version()+1))}markSeen(t,e){let n="d-"+e,r=this.store[n]||[];r.filter(o=>!o.seen).length&&(this.socket.emit("markSeen",{conversationId:t,userId:this.patientId}),this.store[n]=r.map(o=>x(f({},o),{seen:!0})),this.version.set(this.version()+1))}loadDoctors(){let t=this.route.snapshot.paramMap.get("threadId")||"";this.doctorService.getMyPatients().subscribe(e=>{if(!e||!e.length)return;let n=e.map(i=>({userId:i.userId,id:"d-"+i.userId,name:i.fullName,spec:i.department,avatarUrl:i.avatarUrl,online:!0}));this.threads.set([...n]);let r=n.find(i=>i.userId==t);r||(r=n[0]),r&&(this.selectedUserId.set(r.userId),this.loadChatHistory(Number(r.userId)))})}activeThread=I(()=>{let t=this.threads();if(t.length)return t.find(e=>e.userId==this.selectedUserId())||t[0]});messages=I(()=>{this.version();let t=this.activeThread();if(!t)return[];let e=this.store[t.id]||[],n=this.chatQuery().trim().toLowerCase(),r=n?e.filter(i=>i.text.toLowerCase().includes(n)):e;return r.map((i,o)=>{let g=r[o-1],M=g?i.ts.getTime()-g.ts.getTime():1/0;return x(f({},i),{showStamp:M>1e3*60*20})})});trackById=(t,e)=>e.id;select(t){this.selectedUserId.set(t.userId),this.threads.set(this.threads().map(e=>e.userId==t.userId?x(f({},e),{unread:0}):e)),this.loadChatHistory(Number(t.userId))}unreadThreads=I(()=>this.threads().map(e=>{let r=(this.store[e.id]||[]).some(i=>!i.seen&&i.from==="doc");return x(f({},e),{unread:r?1:0})}));filteredThreads=I(()=>{let t=this.query().trim().toLowerCase();return t?this.threads().filter(e=>e.name.toLowerCase().includes(t)||e.spec.toLowerCase().includes(t)):this.threads()});loadEarlier(){let t=this.activeThread(),e=Number(t?.userId),n=this.patientId;if(!t)return;let r=[{id:X(),from:"doc",text:"Previous notes\u2026",ts:new Date(Date.now()-1e3*60*60*5),senderId:e,receiverId:n,seen:!0}];this.store[t.id]=[...r,...this.store[t.id]||[]],this.version.set(this.version()+1)}attach(){alert("Attachment picker coming soon")}send(){let t=this.activeThread(),e=this.patientId;if(!t||!e)return;let n=this.draft().trim();if(!n)return;let r=Number(t.userId),i={id:X(),senderId:e,receiverId:r,from:"me",text:n,ts:new Date,seen:!1},o=this.store[t.id]||[];this.store[t.id]=[...o,i],this.draft.set(""),this.version.set(this.version()+1),this.socket.emit("sendMessage",{senderId:e,receiverId:r,content:n,type:"TEXT"}),this.doctorService.sendMessageToServer(n,r).subscribe({next:g=>{console.log("Message sent successfully",g)},error:g=>{console.error("Failed to send message",g)}}),this.socket.once("messageAck",()=>{i.seen=!0,this.version.set(this.version()+1)})}static \u0275fac=function(e){return new(e||c)};static \u0275cmp=E({type:c,selectors:[["app-doctor-inbox"]],decls:39,vars:13,consts:[["scrollArea",""],[1,"chat-vert"],[1,"strip-panel","card"],[1,"strip-header"],[1,"title"],[1,"search"],["placeholder","Search doctors",1,"search-input",3,"input","value"],[1,"search-ico"],["tabindex","0","aria-label","Conversations",1,"strip"],["class","tile",3,"active","click",4,"ngFor","ngForOf","ngForTrackBy"],[1,"conversation","card","panel"],[1,"conv-header"],[1,"doc"],["class","presence",4,"ngIf"],[1,"avatar",3,"src","alt"],[1,"name"],[1,"sub"],["placeholder","Search in chat\u2026",1,"inline-search",3,"input","value"],["mat-stroked-button","",1,"load",3,"click"],[1,"conv-body"],[4,"ngFor","ngForOf","ngForTrackBy"],[1,"composer"],["mat-icon-button","",1,"ghost",3,"click"],["placeholder","Type your message\u2026",1,"draft",3,"keydown.enter","input","value"],["mat-flat-button","","color","primary",3,"click"],[1,"tile",3,"click"],[1,"meta"],["class","badge",4,"ngIf"],[1,"badge"],[1,"presence"],[1,"msg"],["class","stamp",4,"ngIf"],[1,"bubble"],[4,"ngIf"],[1,"stamp"]],template:function(e,n){if(e&1){let r=O();a(0,"div",1)(1,"section",2)(2,"div",3)(3,"div",4)(4,"mat-icon"),p(5,"forum"),s(),a(6,"h2"),p(7,"Messages"),s()(),a(8,"div",5)(9,"input",6),b("input",function(o){return m(r),u(n.query.set(o.target.value))}),s(),a(10,"mat-icon",7),p(11,"search"),s()()(),a(12,"div",8),_(13,W,8,8,"button",9),s()(),a(14,"section",10)(15,"header",11)(16,"div",12),_(17,Y,1,0,"span",13),y(18,"img",14),a(19,"div")(20,"div",15),p(21),s(),a(22,"div",16),p(23),s()()(),a(24,"input",17),b("input",function(o){return m(r),u(n.chatQuery.set(o.target.value))}),s()(),a(25,"button",18),b("click",function(){return m(r),u(n.loadEarlier())}),p(26,"Load earlier"),s(),a(27,"div",19,0),_(29,te,10,9,"ng-container",20),s(),a(30,"footer",21)(31,"button",22),b("click",function(){return m(r),u(n.attach())}),a(32,"mat-icon"),p(33,"attach_file"),s()(),a(34,"input",23),b("keydown.enter",function(){return m(r),u(n.send())})("input",function(o){return m(r),u(n.draft.set(o.target.value))}),s(),a(35,"button",24),b("click",function(){return m(r),u(n.send())}),a(36,"mat-icon"),p(37,"send"),s(),p(38," Send "),s()()()()}if(e&2){let r,i,o,g,M;d(9),l("value",n.query()),d(4),l("ngForOf",n.filteredThreads())("ngForTrackBy",n.trackById),d(4),l("ngIf",(r=n.activeThread())==null?null:r.online),d(),l("alt",T((i=n.activeThread())==null?null:i.name))("src",(o=n.activeThread())==null?null:o.avatarUrl,k),d(3),h((g=n.activeThread())==null?null:g.name),d(2),h((M=n.activeThread())==null?null:M.spec),d(),l("value",n.chatQuery()),d(5),l("ngForOf",n.messages())("ngForTrackBy",n.trackById),d(5),l("value",n.draft())}},dependencies:[U,V,z,j,H,$,Q,L,q,A],styles:['@charset "UTF-8";.chat-vert[_ngcontent-%COMP%]{max-width:var(--container);margin:0 auto;padding:12px 12px 28px;display:grid;gap:18px}.strip-panel.card[_ngcontent-%COMP%]{position:sticky;top:8px;z-index:5;padding:14px;border-radius:var(--radius-xl);background:var(--surface);border:1px solid var(--border);box-shadow:var(--shadow-sm)}.strip-header[_ngcontent-%COMP%]{display:grid;grid-template-columns:auto 1fr;gap:14px;align-items:center;margin-bottom:10px}.strip-header[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px}.strip-header[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0}.strip-header[_ngcontent-%COMP%]   .search[_ngcontent-%COMP%]{position:relative}.search-input[_ngcontent-%COMP%]{width:100%;height:42px;padding:0 40px 0 14px;border-radius:14px;border:1px solid var(--border);background:#ffffff0a;color:var(--text)}.search-ico[_ngcontent-%COMP%]{position:absolute;right:10px;top:50%;translate:0 -50%;opacity:.7}.strip[_ngcontent-%COMP%]{display:grid;grid-auto-flow:column;grid-auto-columns:max-content;gap:14px;overflow-x:auto;padding-bottom:4px;scrollbar-width:thin}.tile[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;padding:8px 14px;border-radius:999px;border:1px solid var(--border);background:#ffffff08;color:var(--text);cursor:pointer;white-space:nowrap}.tile.active[_ngcontent-%COMP%]{background:linear-gradient(180deg,#1db7a024,#3b8bd31a);box-shadow:0 8px 20px #3b8bd32e}.tile[_ngcontent-%COMP%]   .avatar[_ngcontent-%COMP%]{width:34px;height:34px;border-radius:50%;object-fit:cover}.tile[_ngcontent-%COMP%]   .meta[_ngcontent-%COMP%]{display:grid;line-height:1.1}.tile[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{font-weight:700;letter-spacing:.2px}.tile[_ngcontent-%COMP%]   .sub[_ngcontent-%COMP%]{font-size:12px;opacity:.8}.tile[_ngcontent-%COMP%]   .time[_ngcontent-%COMP%]{margin-left:6px;font-size:12px;opacity:.75}.tile[_ngcontent-%COMP%]   .badge[_ngcontent-%COMP%]{margin-left:8px;font-size:12px;background:var(--brand-600);color:#fff;padding:2px 8px;border-radius:999px}.conversation.card.panel[_ngcontent-%COMP%]{display:grid;gap:14px;padding:0 0 12px;border-radius:var(--radius-xl);border:1px solid var(--border);background:var(--surface);box-shadow:var(--shadow)}.conv-header[_ngcontent-%COMP%]   .doc[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px}.conv-header[_ngcontent-%COMP%]   .avatar[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:50%;object-fit:cover}.conv-header[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{font-weight:800;margin-bottom:2px}.conv-header[_ngcontent-%COMP%]   .sub[_ngcontent-%COMP%]{font-size:12.5px;opacity:.85}.conv-header[_ngcontent-%COMP%]   .presence[_ngcontent-%COMP%]{width:9px;height:9px;border-radius:50%;background:#22c55e;display:inline-block;box-shadow:0 0 0 3px #22c55e2e}.inline-search[_ngcontent-%COMP%]{width:min(360px,42vw);height:38px;border-radius:12px;border:1px solid var(--border);padding:0 12px;background:#ffffff0d;color:var(--text)}.load[_ngcontent-%COMP%]{align-self:center;width:max-content;margin:10px auto 0}.conv-body[_ngcontent-%COMP%]{display:grid;gap:10px;padding:8px 16px 18px;min-height:62vh}.msg[_ngcontent-%COMP%]{display:grid;justify-content:start;gap:6px}.msg.me[_ngcontent-%COMP%]{justify-content:end}.msg[_ngcontent-%COMP%]   .stamp[_ngcontent-%COMP%]{place-self:center;font-size:12px;opacity:.8;background:#ffffff0f;padding:2px 10px;border-radius:999px}.bubble[_ngcontent-%COMP%]{max-width:70ch;padding:12px 14px;border-radius:16px;border:1px solid var(--border);background:#ffffff0d;line-height:1.35}.msg.me[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{background:linear-gradient(180deg,#3b8bd32e,#1db7a01f);border-color:#3b8bd340}.msg[_ngcontent-%COMP%]   .meta[_ngcontent-%COMP%]{font-size:12px;opacity:.8;margin-top:2px;text-align:right}.composer[_ngcontent-%COMP%]{position:sticky;bottom:8px;z-index:3;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;padding:10px 12px;margin:0 12px 8px;border-radius:16px;border:1px solid var(--border);background:linear-gradient(180deg,#0a0e16e6,#0a0e16db);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px)}.composer[_ngcontent-%COMP%]   .draft[_ngcontent-%COMP%]{height:44px;border-radius:12px;border:1px solid var(--border);background:#ffffff0a;color:var(--text);padding:0 12px}.composer[_ngcontent-%COMP%]   .ghost[_ngcontent-%COMP%]{opacity:.8}[_ngcontent-%COMP%]:root{--chat-offset: 180px}.conversation.card.panel[_ngcontent-%COMP%]{display:grid;grid-template-rows:auto minmax(0,1fr) auto;gap:14px;padding:0 0 12px;border-radius:var(--radius-xl);border:1px solid var(--border);background:var(--surface);box-shadow:var(--shadow);height:calc(100vh - var(--chat-offset));max-height:92vh;overflow:hidden}.conv-header[_ngcontent-%COMP%]{position:sticky;top:0;z-index:4;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0a0e16f2,#0a0e16cc);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);border-top-left-radius:var(--radius-xl);border-top-right-radius:var(--radius-xl)}.conv-body[_ngcontent-%COMP%]{display:grid;gap:10px;padding:8px 16px 18px;overflow-y:auto;overflow-x:hidden;overscroll-behavior:contain;scrollbar-gutter:stable both-edges}.composer[_ngcontent-%COMP%]{position:relative;bottom:auto;z-index:3;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;padding:10px 12px;margin:0 12px 8px;border-radius:16px;border:1px solid var(--border);background:linear-gradient(180deg,#0a0e16e6,#0a0e16db);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px)}.chat-vert[_ngcontent-%COMP%]{height:100dvh;overflow:hidden;display:grid;grid-template-rows:auto 1fr}.strip-panel.card[_ngcontent-%COMP%]{position:sticky;top:8px;z-index:8}.conversation.card.panel[_ngcontent-%COMP%]{height:100%;overflow:hidden;display:grid;grid-template-rows:auto minmax(0,1fr) auto;gap:14px}.conv-header[_ngcontent-%COMP%]{position:sticky;top:0;z-index:4}.conv-body[_ngcontent-%COMP%]{overflow-y:auto;overflow-x:hidden;min-height:0;padding:8px 16px 18px;scrollbar-gutter:stable both-edges;overscroll-behavior:contain}.composer[_ngcontent-%COMP%]{position:relative;bottom:auto;margin:0 12px 8px}']})};export{G as DoctorInboxComponent};
